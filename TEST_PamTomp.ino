#include <Wire.h> //for I2C
#include <Arduino_LSM6DSOX.h>

#define SAMPLINGRATE 250 //Hz
#define SAMPLINGPERIOD 10 //ms (1/SAMPLINGRATE)
#define ECG_PIN A0
#define REFRACTORY 200 // period to wait before another R-wave is possible (ms)
#define TEST_DATA 1000 //size of test data array

// Pan-Tompkins parameters
const int windowSize = 10; // May need tuning -> QRS duration estimated 100ms -> QRS duration(ms)/SAMPLINGPERIOD(ms)
float integratedSignal[windowSize] = {0};
float threshold = 0.5; // Needs to be tuned according to actual QRS amplitude
long lastRPeakTime = 0; //used to store the timestamp of the last detected R-peak. Initially set to 0

const float testData[TEST_DATA] = {1.25110746174107e-137,5.46398402472367e-127,8.7786906567867e-117,5.18866448123585e-107,1.12820221856476e-97,9.02451411386314e-89,2.65562180398365e-80,2.87484306150778e-72,1.14490005416734e-64,1.67736095933739e-57,9.04046999069374e-51,1.79250766123562e-44,1.30748462778749e-38,3.50847020593575e-33,3.46341726246755e-28,1.25776118686981e-23,1.68034837829958e-19,8.25870799340704e-16,1.49329980193388e-12,9.93418598680903e-10,2.43188563002412e-07,2.19165373683418e-05,0.000727868428720206,0.00891904904558146,0.0400221089007828,0.0590607995005814,-0.00842485665138095,-0.0864647807725942,-0.0674695717989063,-0.0210886995941675,0.00271739605401848,0.0181292841613196,0.0202723041398026,0.0173863992476359,0.012582711481204,0.00687268278585278,0.00298986658980745,8.47509539205971e-05,-0.00128966982855685,-0.00171821981487265,-0.00161299335147992,-0.00116215665761133,-0.000724383179807029,-0.000325491661497984,-6.04908136493625e-05,8.56682641410271e-05,0.0001461982390932,0.000141094026765966,0.000111481038741189,7.10693658647203e-05,3.5716225674772e-05,1.03834361177092e-05,-5.14773442781995e-06,-1.15463945933101e-05,-1.25697430287548e-05,-1.02985761008731e-05,-6.95461629767655e-06,-3.80172441012864e-06,-1.3467901147971e-06,1.55943760378506e-07,9.03865692076119e-07,1.08400516115602e-06,9.43144312169003e-07,6.73424830628127e-07,3.88857083812157e-07,1.63760303276084e-07,1.31315897278036e-08,-6.58208097282232e-08,-9.16770070766338e-08,-8.55489397067323e-08,-6.38378612215309e-08,-3.93626934923584e-08,-1.84280921902797e-08,-3.87056229817311e-09,4.32709432060319e-09,7.59696315856399e-09,7.6077301788945e-09,6.00173899245819e-09,3.89726367864374e-09,1.99521474592254e-09,6.05249840664322e-10,-2.32886884780033e-10,-6.06674896725001e-10,-6.67896691172839e-10,-5.55865900694159e-10,-3.80026792426746e-10,-2.09737694946169e-10,-7.81699155792932e-11,5.19661780755018e-12,4.65000962193498e-11,5.75195856133659e-11,5.08025516588291e-11,3.65545504266445e-11,2.14829645880252e-11,9.24831056563831e-12,1.05263060786777e-12,-3.33435679999609e-12,-4.84756243355456e-12,-4.58189334908023e-12,-4.0503415854562e-07,-0.108684907352036,-0.0188562625454319,0.680389877622192,0.109463702490807,-0.870915491948451,-0.097562536464894,0.127758398506206,-0.0434359744192879,0.14110969844071,0.0225778249883157,0.0481837646139171,0.0280862761089391,-0.00177498740461501,0.00859620361155592,-0.0102601631876302,-0.00355154495389448,-0.00553640636733474,-0.00456282907765438,-0.00132656747631092,-0.00172377864349423,0.000283633129278999,0.00018530760014534,0.000484262309866046,0.000554451235024233,0.000278988813381743,0.000285761540537166,8.02127877138913e-05,3.51640340917992e-05,-1.69749840766501e-05,-4.85433763707671e-05,-3.50235519634627e-05,-3.83834796289397e-05,-2.03251775918096e-05,-1.20835653462164e-05,-4.30654378516362e-06,2.25048802153682e-06,5.41294148793959e-06,1.63907815811148e-05,5.19927606850855e-05,0.000175119821000285,0.000544529646431442,0.00151635560448148,0.00374865458328567,0.00818342839469374,0.0156844587323185,0.0261533587003891,0.0373479482858266,0.0442737412080017,0.0403505311509915,0.0207715499735867,-0.013413715239288,-0.0534907330240839,-0.0858151766248752,-0.0982375389133024,-0.0863019529232126,-0.0551918052236594,-0.0164699478846203,0.0178068916521023,0.0398851298697199,0.0479031777531965,0.044579255409761,0.0346691699833722,0.0227481141116711,0.0120142043686907,0.00405101456356768,-0.00084379542846705,-0.00314553767150169,-0.00364120010589323,-0.00311430960441422,-0.00218088188211294,-0.00124057483689552,-0.000497808897815684,-1.41639536292776e-05,0.000234485184813337,0.000310631211239828,0.000282891333471194,0.000208323199911558,0.000125915336217575,5.71443008163168e-05,1.00015821970789e-05,-1.60783045399353e-05,-2.5885639680859e-05,-2.53321515479815e-05,-1.96352110687695e-05,-1.25441171202229e-05,-6.26102669322097e-06,-1.7315679049502e-06,9.3893336504966e-07,2.09441999691035e-06,2.23346500407495e-06,1.82657925081162e-06,1.22942996167309e-06,6.63321231106333e-07,2.34006936806697e-07,-3.40511638082354e-08,-1.62905597819496e-07,-1.93516666471599e-07,-1.67690011419221e-07,-1.18722809325909e-07,-6.84724597727337e-08,-2.83136569231471e-08,-1.86557647832701e-09,1.19650324256268e-08,1.64309149125282e-08,1.51861079222932e-08,1.1307236660476e-08,6.91992305386101e-09,3.21237415640553e-09,6.42696275518008e-10,-7.99728942451713e-10,-1.36129336300136e-09,-1.35545036967288e-09,-1.06269650277203e-09,-6.86822704216789e-10,-3.49095499584657e-10,-1.02945072860518e-10,4.40723686351646e-11,1.09313363713555e-10,1.19076596362194e-10,1.00069320871445e-10,1.06050882942059e-09,2.43225319596457e-07,2.19165508615592e-05,0.000727868427514265,0.00891904903716832,0.0400221088905081,0.059060799491558,-0.00842485665783974,-0.0864647807763697,-0.0674695718005119,-0.0210886995943279,0.0027173960546264,0.0181292841621877,0.0202723041406173,0.0173863992482492,0.012582711481584,0.00687268278603299,0.0029898665898477,8.475095388115e-05,-0.00128966982862833,-0.00171821981494512,-0.0016129933515374,-0.00116215665764891,-0.000724383179826464,-0.000325491661504051,-6.04908136473434e-05,8.56682641467212e-05,0.000146198239099543,0.000141094026771283,0.000111481038744847,7.10693658667547e-05,3.57162256755466e-05,1.03834361176784e-05,-5.14773442825318e-06,-1.15463945938551e-05,-1.25697430292401e-05,-1.02985761012242e-05,-6.95461629788453e-06,-3.80172441021944e-06,-1.34679011480898e-06,1.55943760409244e-07,9.0386569212193e-07,1.0840051611997e-06,9.43144312202252e-07,6.73424830648973e-07,3.88857083822249e-07,1.63760303278556e-07,1.31315897258775e-08,-6.58208097319712e-08,-9.16770070805057e-08,-8.55489397098393e-08,-6.38378612235852e-08,-3.9362693493439e-08,-1.84280921906347e-08,-3.8705622980837e-09,4.32709432089917e-09,7.59696315890159e-09,7.60773017918106e-09,6.00173899265756e-09,3.89726367875621e-09,1.99521474596683e-09,6.0524984066452e-10,-2.32886884802271e-10,-6.06674896753879e-10,-6.67896691198915e-10,-5.55865900713237e-10,-3.80026792438191e-10,-2.09737694951292e-10,-7.8169915580109e-11,5.19661780909573e-12,4.65000962217643e-11,5.75195856157054e-11,5.08025516606304e-11,3.65545504277873e-11,2.14829645885893e-11,9.24831056578791e-12,1.05263060777487e-12,-3.33435680019228e-12,-4.84756243376125e-12,-4.58189334924808e-12,-4.0503415854562e-07,-0.108684907352036,-0.0188562625454319,0.680389877622192,0.109463702490807,-0.870915491948451,-0.097562536464894,0.127758398506206,-0.0434359744192879,0.14110969844071,0.0225778249883157,0.0481837646139171,0.0280862761089391,-0.00177498740461501,0.00859620361155592,-0.0102601631876302,-0.00355154495389448,-0.00553640636733474,-0.00456282907765438,-0.00132656747631092,-0.00172377864349423,0.000283633129278999,0.00018530760014534,0.000484262309866046,0.000554451235024233,0.000278988813381743,0.000285761540537166,8.02127877138913e-05,3.51640340917992e-05,-1.69749840766501e-05,-4.85433763707671e-05,-3.50235519634627e-05,-3.83834796289397e-05,-2.03251775918096e-05,-1.20835653462164e-05,-4.30654378516362e-06,2.25048802153682e-06,5.41294148793959e-06,1.63907815811148e-05,5.19927606850855e-05,0.000175119821000285,0.000544529646431442,0.00151635560448148,0.00374865458328567,0.00818342839469374,0.0156844587323185,0.0261533587003891,0.0373479482858266,0.0442737412080017,0.0403505311509915,0.0207715499735867,-0.013413715239288,-0.0534907330240839,-0.0858151766248752,-0.0982375389133024,-0.0863019529232126,-0.0551918052236594,-0.0164699478846203,0.0178068916521023,0.0398851298697199,0.0479031777531965,0.044579255409761,0.0346691699833722,0.0227481141116711,0.0120142043686907,0.00405101456356768,-0.00084379542846705,-0.00314553767150169,-0.00364120010589323,-0.00311430960441422,-0.00218088188211294,-0.00124057483689552,-0.000497808897815684,-1.41639536292776e-05,0.000234485184813337,0.000310631211239828,0.000282891333471194,0.000208323199911558,0.000125915336217575,5.71443008163168e-05,1.00015821970789e-05,-1.60783045399353e-05,-2.5885639680859e-05,-2.53321515479815e-05,-1.96352110687695e-05,-1.25441171202229e-05,-6.26102669322097e-06,-1.7315679049502e-06,9.3893336504966e-07,2.09441999691035e-06,2.23346500407495e-06,1.82657925081162e-06,1.22942996167309e-06,6.63321231106333e-07,2.34006936806697e-07,-3.40511638082354e-08,-1.62905597819496e-07,-1.93516666471599e-07,-1.67690011419221e-07,-1.18722809325909e-07,-6.84724597727337e-08,-2.83136569231471e-08,-1.86557647832701e-09,1.19650324256268e-08,1.64309149125282e-08,1.51861079222932e-08,1.1307236660476e-08,6.91992305386101e-09,3.21237415640553e-09,6.42696275518008e-10,-7.99728942451713e-10,-1.36129336300136e-09,-1.35545036967288e-09,-1.06269650277203e-09,-6.86822704216789e-10,-3.49095499584657e-10,-1.02945072860518e-10,4.40723686351646e-11,1.09313363713555e-10,1.19076596362194e-10,1.00069320871445e-10,1.06050882942059e-09,2.43225319596457e-07,2.19165508615592e-05,0.000727868427514265,0.00891904903716832,0.0400221088905081,0.059060799491558,-0.00842485665783974,-0.0864647807763697,-0.0674695718005119,-0.0210886995943279,0.0027173960546264,0.0181292841621877,0.0202723041406173,0.0173863992482492,0.012582711481584,0.00687268278603299,0.0029898665898477,8.475095388115e-05,-0.00128966982862833,-0.00171821981494512,-0.0016129933515374,-0.00116215665764891,-0.000724383179826464,-0.000325491661504051,-6.04908136473434e-05,8.56682641467212e-05,0.000146198239099543,0.000141094026771283,0.000111481038744847,7.10693658667547e-05,3.57162256755466e-05,1.03834361176784e-05,-5.14773442825318e-06,-1.15463945938551e-05,-1.25697430292401e-05,-1.02985761012242e-05,-6.95461629788453e-06,-3.80172441021944e-06,-1.34679011480898e-06,1.55943760409244e-07,9.0386569212193e-07,1.0840051611997e-06,9.43144312202252e-07,6.73424830648973e-07,3.88857083822249e-07,1.63760303278556e-07,1.31315897258775e-08,-6.58208097319712e-08,-9.16770070805057e-08,-8.55489397098393e-08,-6.38378612235852e-08,-3.9362693493439e-08,-1.84280921906347e-08,-3.8705622980837e-09,4.32709432089917e-09,7.59696315890159e-09,7.60773017918106e-09,6.00173899265756e-09,3.89726367875621e-09,1.99521474596683e-09,6.0524984066452e-10,-2.32886884802271e-10,-6.06674896753879e-10,-6.67896691198915e-10,-5.55865900713237e-10,-3.80026792438191e-10,-2.09737694951292e-10,-7.8169915580109e-11,5.19661780909573e-12,4.65000962217643e-11,5.75195856157054e-11,5.08025516606304e-11,3.65545504277873e-11,2.14829645885893e-11,9.24831056578791e-12,1.05263060777487e-12,-3.33435680019228e-12,-4.84756243376125e-12,-4.58189334924808e-12,-4.0503415854562e-07,-0.108684907352036,-0.0188562625454319,0.680389877622192,0.109463702490807,-0.870915491948451,-0.097562536464894,0.127758398506206,-0.0434359744192879,0.14110969844071,0.0225778249883157,0.0481837646139171,0.0280862761089391,-0.00177498740461501,0.00859620361155592,-0.0102601631876302,-0.00355154495389448,-0.00553640636733474,-0.00456282907765438,-0.00132656747631092,-0.00172377864349423,0.000283633129278999,0.00018530760014534,0.000484262309866046,0.000554451235024233,0.000278988813381743,0.000285761540537166,8.02127877138913e-05,3.51640340917992e-05,-1.69749840766501e-05,-4.85433763707671e-05,-3.50235519634627e-05,-3.83834796289397e-05,-2.03251775918096e-05,-1.20835653462164e-05,-4.30654378516362e-06,2.25048802153682e-06,5.41294148793959e-06,1.63907815811148e-05,5.19927606850855e-05,0.000175119821000285,0.000544529646431442,0.00151635560448148,0.00374865458328567,0.00818342839469374,0.0156844587323185,0.0261533587003891,0.0373479482858266,0.0442737412080017,0.0403505311509915,0.0207715499735867,-0.013413715239288,-0.0534907330240839,-0.0858151766248752,-0.0982375389133024,-0.0863019529232126,-0.0551918052236594,-0.0164699478846203,0.0178068916521023,0.0398851298697199,0.0479031777531965,0.044579255409761,0.0346691699833722,0.0227481141116711,0.0120142043686907,0.00405101456356768,-0.00084379542846705,-0.00314553767150169,-0.00364120010589323,-0.00311430960441422,-0.00218088188211294,-0.00124057483689552,-0.000497808897815684,-1.41639536292776e-05,0.000234485184813337,0.000310631211239828,0.000282891333471194,0.000208323199911558,0.000125915336217575,5.71443008163168e-05,1.00015821970789e-05,-1.60783045399353e-05,-2.5885639680859e-05,-2.53321515479815e-05,-1.96352110687695e-05,-1.25441171202229e-05,-6.26102669322097e-06,-1.7315679049502e-06,9.3893336504966e-07,2.09441999691035e-06,2.23346500407495e-06,1.82657925081162e-06,1.22942996167309e-06,6.63321231106333e-07,2.34006936806697e-07,-3.40511638082354e-08,-1.62905597819496e-07,-1.93516666471599e-07,-1.67690011419221e-07,-1.18722809325909e-07,-6.84724597727337e-08,-2.83136569231471e-08,-1.86557647832701e-09,1.19650324256268e-08,1.64309149125282e-08,1.51861079222932e-08,1.1307236660476e-08,6.91992305386101e-09,3.21237415640553e-09,6.42696275518008e-10,-7.99728942451713e-10,-1.36129336300136e-09,-1.35545036967288e-09,-1.06269650277203e-09,-6.86822704216789e-10,-3.49095499584657e-10,-1.02945072860518e-10,4.40723686351646e-11,1.09313363713555e-10,1.19076596362194e-10,1.00069320871445e-10,1.06050882942059e-09,2.43225319596457e-07,2.19165508615592e-05,0.000727868427514265,0.00891904903716832,0.0400221088905081,0.059060799491558,-0.00842485665783974,-0.0864647807763697,-0.0674695718005119,-0.0210886995943279,0.0027173960546264,0.0181292841621877,0.0202723041406173,0.0173863992482492,0.012582711481584,0.00687268278603299,0.0029898665898477,8.475095388115e-05,-0.00128966982862833,-0.00171821981494512,-0.0016129933515374,-0.00116215665764891,-0.000724383179826464,-0.000325491661504051,-6.04908136473434e-05,8.56682641467212e-05,0.000146198239099543,0.000141094026771283,0.000111481038744847,7.10693658667547e-05,3.57162256755466e-05,1.03834361176784e-05,-5.14773442825318e-06,-1.15463945938551e-05,-1.25697430292401e-05,-1.02985761012242e-05,-6.95461629788453e-06,-3.80172441021944e-06,-1.34679011480898e-06,1.55943760409244e-07,9.0386569212193e-07,1.0840051611997e-06,9.43144312202252e-07,6.73424830648973e-07,3.88857083822249e-07,1.63760303278556e-07,1.31315897258775e-08,-6.58208097319712e-08,-9.16770070805057e-08,-8.55489397098393e-08,-6.38378612235852e-08,-3.9362693493439e-08,-1.84280921906347e-08,-3.8705622980837e-09,4.32709432089917e-09,7.59696315890159e-09,7.60773017918106e-09,6.00173899265756e-09,3.89726367875621e-09,1.99521474596683e-09,6.0524984066452e-10,-2.32886884802271e-10,-6.06674896753879e-10,-6.67896691198915e-10,-5.55865900713237e-10,-3.80026792438191e-10,-2.09737694951292e-10,-7.8169915580109e-11,5.19661780909573e-12,4.65000962217643e-11,5.75195856157054e-11,5.08025516606304e-11,3.65545504277873e-11,2.14829645885893e-11,9.24831056578791e-12,1.05263060777487e-12,-3.33435680019228e-12,-4.84756243376125e-12,-4.58189334924808e-12,-4.0503415854562e-07,-0.108684907352036,-0.0188562625454319,0.680389877622192,0.109463702490807,-0.870915491948451,-0.097562536464894,0.127758398506206,-0.0434359744192879,0.14110969844071,0.0225778249883157,0.0481837646139171,0.0280862761089391,-0.00177498740461501,0.00859620361155592,-0.0102601631876302,-0.00355154495389448,-0.00553640636733474,-0.00456282907765438,-0.00132656747631092,-0.00172377864349423,0.000283633129278999,0.00018530760014534,0.000484262309866046,0.000554451235024233,0.000278988813381743,0.000285761540537166,8.02127877138913e-05,3.51640340917992e-05,-1.69749840766501e-05,-4.85433763707671e-05,-3.50235519634627e-05,-3.83834796289397e-05,-2.03251775918096e-05,-1.20835653462164e-05,-4.30654378516362e-06,2.25048802153682e-06,5.41294148793959e-06,1.63907815811148e-05,5.19927606850855e-05,0.000175119821000285,0.000544529646431442,0.00151635560448148,0.00374865458328567,0.00818342839469374,0.0156844587323185,0.0261533587003891,0.0373479482858266,0.0442737412080017,0.0403505311509915,0.0207715499735867,-0.013413715239288,-0.0534907330240839,-0.0858151766248752,-0.0982375389133024,-0.0863019529232126,-0.0551918052236594,-0.0164699478846203,0.0178068916521023,0.0398851298697199,0.0479031777531965,0.044579255409761,0.0346691699833722,0.0227481141116711,0.0120142043686907,0.00405101456356768,-0.00084379542846705,-0.00314553767150169,-0.00364120010589323,-0.00311430960441422,-0.00218088188211294,-0.00124057483689552,-0.000497808897815684,-1.41639536292776e-05,0.000234485184813337,0.000310631211239828,0.000282891333471194,0.000208323199911558,0.000125915336217575,5.71443008163168e-05,1.00015821970789e-05,-1.60783045399353e-05,-2.5885639680859e-05,-2.53321515479815e-05,-1.96352110687695e-05,-1.25441171202229e-05,-6.26102669322097e-06,-1.7315679049502e-06,9.3893336504966e-07,2.09441999691035e-06,2.23346500407495e-06,1.82657925081162e-06,1.22942996167309e-06,6.63321231106333e-07,2.34006936806697e-07,-3.40511638082354e-08,-1.62905597819496e-07,-1.93516666471599e-07,-1.67690011419221e-07,-1.18722809325909e-07,-6.84724597727337e-08,-2.83136569231471e-08,-1.86557647832701e-09,1.19650324256268e-08,1.64309149125282e-08,1.51861079222932e-08,1.1307236660476e-08,6.91992305386101e-09,3.21237415640553e-09,6.42696275518008e-10,-7.99728942451713e-10,-1.36129336300136e-09,-1.35545036967288e-09,-1.06269650277203e-09,-6.86822704216789e-10,-3.49095499584657e-10,-1.02945072860518e-10,4.40723686351646e-11,1.09313363713555e-10,1.19076596362194e-10,1.00069320871445e-10,1.06050882942059e-09,2.43225319596457e-07,2.19165508615592e-05,0.000727868427514265,0.00891904903716832,0.0400221088905081,0.059060799491558,-0.00842485665783974,-0.0864647807763697,-0.0674695718005119,-0.0210886995943279,0.0027173960546264,0.0181292841621877,0.0202723041406173,0.0173863992482492,0.012582711481584,0.00687268278603299,0.0029898665898477,8.475095388115e-05,-0.00128966982862833,-0.00171821981494512,-0.0016129933515374,-0.00116215665764891,-0.000724383179826464,-0.000325491661504051,-6.04908136473434e-05,8.56682641467212e-05,0.000146198239099543,0.000141094026771283,0.000111481038744847,7.10693658667547e-05,3.57162256755466e-05,1.03834361176784e-05,-5.14773442825318e-06,-1.15463945938551e-05,-1.25697430292401e-05,-1.02985761012242e-05,-6.95461629788453e-06,-3.80172441021944e-06,-1.34679011480898e-06,1.55943760409244e-07,9.0386569212193e-07,1.0840051611997e-06,9.43144312202252e-07,6.73424830648973e-07,3.88857083822249e-07,1.63760303278556e-07,1.31315897258775e-08,-6.58208097319712e-08,-9.16770070805057e-08,-8.55489397098393e-08,-6.38378612235852e-08,-3.9362693493439e-08,-1.84280921906347e-08,-3.8705622980837e-09,4.32709432089917e-09,7.59696315890159e-09,7.60773017918106e-09,6.00173899265756e-09,3.89726367875621e-09,1.99521474596683e-09,6.0524984066452e-10,-2.32886884802271e-10,-6.06674896753879e-10,-6.67896691198915e-10,-5.55865900713237e-10,-3.80026792438191e-10,-2.09737694951292e-10,-7.8169915580109e-11,5.19661780909573e-12,4.65000962217643e-11,5.75195856157054e-11,5.08025516606304e-11,3.65545504277873e-11,2.14829645885893e-11,9.24831056578791e-12,1.05263060777487e-12,-3.33435680019228e-12,-4.84756243376125e-12,-4.58189334924808e-12,-4.0503415854562e-07,-0.108684907352036,-0.0188562625454319,0.680389877622192,0.109463702490807,-0.870915491948451,-0.097562536464894,0.127758398506206,-0.0434359744192879,0.14110969844071,0.0225778249883157,0.0481837646139171,0.0280862761089391,-0.00177498740461501,0.00859620361155592,-0.0102601631876302,-0.00355154495389448,-0.00553640636733474,-0.00456282907765438,-0.00132656747631092,-0.00172377864349423,0.000283633129278999,0.00018530760014534,0.000484262309866046,0.000554451235024233,0.000278988813381743,0.000285761540537166,8.02127877138913e-05,3.51640340917992e-05,-1.69749840766501e-05,-4.85433763707671e-05,-3.50235519634627e-05,-3.83834796289397e-05,-2.03251775918096e-05,-1.20835653462164e-05,-4.30654378516362e-06,2.25048802153682e-06,5.41294148793959e-06,1.63907815811148e-05,5.19927606850855e-05,0.000175119821000285,0.000544529646431442,0.00151635560448148,0.00374865458328567,0.00818342839469374,0.0156844587323185,0.0261533587003891,0.0373479482858266,0.0442737412080017,0.0403505311509915,0.0207715499735867,-0.013413715239288,-0.0534907330240839,-0.0858151766248752,-0.0982375389133024,-0.0863019529232126,-0.0551918052236594,-0.0164699478846203,0.0178068916521023,0.0398851298697199,0.0479031777531965,0.044579255409761,0.0346691699833722,0.0227481141116711,0.0120142043686907,0.00405101456356768,-0.00084379542846705,-0.00314553767150169,-0.00364120010589323,-0.00311430960441422,-0.00218088188211294,-0.00124057483689552,-0.000497808897815684,-1.41639536292776e-05,0.000234485184813337,0.000310631211239828,0.000282891333471194,0.000208323199911558,0.000125915336217575,5.71443008163168e-05,1.00015821970789e-05,-1.60783045399353e-05,-2.5885639680859e-05,-2.53321515479815e-05,-1.96352110687695e-05,-1.25441171202229e-05,-6.26102669322097e-06,-1.7315679049502e-06,9.3893336504966e-07,2.09441999691035e-06,2.23346500407495e-06,1.82657925081162e-06,1.22942996167309e-06,6.63321231106333e-07,2.34006936806697e-07,-3.40511638082354e-08,-1.62905597819496e-07
};

int testIndex = 0;


void setup() {
  // put your setup code here, to run once:
   Wire.begin();
    Serial.begin(9600);
    IMU.begin();
    Serial.println(" ");
    Serial.println("Started");
}

void loop() {
  // put your main code here, to run repeatedly:
 unsigned long startTime = millis();

    if (testIndex < TEST_DATA){

      float filteredECG = 10*testData[testIndex];
      //Serial.print("Test Data: ");
      //Serial.println(filteredECG);
      testIndex = testIndex + 1;

        // Apply Pan-Tompkins for QRS detection
        if (detectQRS(filteredECG)) {
            float heartRate = calculateHeartRate(millis());
            Serial.println(" ");
            Serial.print("Heart Rate: ");
            Serial.print(heartRate);
            Serial.println(" BPM");
        }
        unsigned long endTime = millis();
        unsigned long elapsedTime = endTime - startTime;

        if (elapsedTime < SAMPLINGPERIOD) { //account for the time that has elapsed during program execution when sampling
            delay(SAMPLINGPERIOD - elapsedTime);
        }

      Serial.print(filteredECG);
      Serial.print("     ");
    }    

}

bool detectQRS(float sample) {
    // Differentiate and square (simplified example)
    static float lastSample = 0;
    float derivative = sample - lastSample;
    lastSample = sample;
    float squared = derivative * derivative;

    // Moving window integration
    static int index = 0;
    integratedSignal[index] = squared;
    index = (index + 1) % windowSize;
    float sum = 0;
    for (int i = 0; i < windowSize; i++) {
        sum += integratedSignal[i];
    }
    float integrated = sum / windowSize;

    // Thresholding for QRS detection
    long currentTime = millis();
    if (integrated > threshold && currentTime - lastRPeakTime > REFRACTORY) { // 200 ms refractory period
        lastRPeakTime = currentTime;
        return true; // QRS detected
    }
    return false;
}

float calculateHeartRate(long rPeakTime) {
    static long lastRPeakTime = 0; //not reinitialized to 0 each time because static

    if (lastRPeakTime == 0) { //if this is the first R peak detected 
        lastRPeakTime = rPeakTime;
        return 0; 
    }
    
    float rrInterval = (rPeakTime - lastRPeakTime) / 1000.0; // Convert milliseconds to seconds
    lastRPeakTime = rPeakTime;
    return 60.0 / rrInterval; // BPM
}

